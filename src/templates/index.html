<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>LiveData – Wikimedia Stream</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- script aburrido para graficar  -->
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1 { margin-bottom: 5px; }
    .subtitle { color: #94a3b8; margin-bottom: 20px; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: #020617;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 0 1px #1e293b;
    }

    .card h2 { font-size: 14px; color: #94a3b8; margin: 0; }
    .card p { font-size: 28px; margin: 5px 0 0; font-weight: bold; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #020617;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 30px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #1e293b;
      font-size: 14px;
    }

    th { color: #94a3b8; }
    .chart-container {
      margin-top: 25px;
      background: #020617;
      padding: 15px;
      border-radius: 12px;
    }
  </style>
</head>

<body>

<h1> LiveData – Wikimedia Stream data</h1>
<div class="subtitle">Ingesta en tiempo real</div>

<div class="cards">
  <div class="card">
    <h2>Total de eventos</h2>
    <p id="total">—</p>
  </div>
  <div class="card">
    <h2>Fuente</h2>
    <p>Wikimedia</p>
  </div>
  <div class="card">
    <h2>Base de datos</h2>
    <p>MongoDB</p>
  </div>
  <div class="card">
  <h2>Tamaño BD (KB)</h2>
  <p id="db-size">—</p>
  </div>
    <div class="card">
  <h2>Ediciones humanas</h2>
  <p id="human-count">—</p>
  </div>
  <div class="card">
  <h2>Ediciones por bots</h2>
  <p id="bot-count">—</p>
  </div>
</div>

<div class="chart-container">
  <canvas id="eventsChart"></canvas>
</div>
<div class="chart-container">
  <canvas id="editTypeChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="botHumanChart"></canvas>
</div>

<div class="chart-container">
  <h2 style="margin-bottom:15px;">Top Usuarios</h2>
  <table>
    <thead>
      <tr>
        <th>Usuario</th>
        <th>Total Ediciones</th>
        <th>Humanas</th>
        <th>Bots</th>
      </tr>
    </thead>
    <tbody id="top-users-body"></tbody>
  </table>
</div>



<table>
  <thead>
    <tr>
      <th>Título</th>
      <th>Usuario</th>
      <th>Wiki</th>
      <th>Bot</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody id="events-body"></tbody>
</table>

<script>
      // contador obtenida de las rutas flask
  async function updateTotal() {
    const res = await fetch("/api/total");
    const data = await res.json();
    document.getElementById("total").textContent = data.total;
  }

  setInterval(updateTotal, 2000);
  updateTotal();

  const ctx = document.getElementById("eventsChart");
  const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Eventos / cada 10 s",
        data: [],
        borderColor: "#38bdf8",
        tension: 0.3
      }]
    },
    options: { animation: false }
  });
// actualizar
  async function updateChart() {
    const res = await fetch("/api/events_last");
    const data = await res.json();

    const label = new Date(data.timestamp * 1000).toLocaleTimeString();
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(data.count);

    if (chart.data.labels.length > 20) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }
// actualizar cada 2 segundos
  setInterval(updateChart, 2000);

  // tabla de eventos de abajo 
  async function updateTable() {
    const res = await fetch("/api/latest_events");
    const data = await res.json();

    const body = document.getElementById("events-body");
    body.innerHTML = "";

    data.forEach(e => {
      body.innerHTML += `
        <tr>
          <td>${e.title || "-"}</td>
          <td>${e.user || "-"}</td>
          <td>${e.wiki || "-"}</td>
          <td>${e.bot}</td>
          <td>${new Date(e.timestamp * 1000).toLocaleTimeString()}</td>
        </tr>`;
    });
  }
// metricas 
  async function updateDbSize() {
    const res = await fetch("/api/bd_metrics");
    const data = await res.json();
    document.getElementById("db-size").textContent = data.size_kb + " KB";
  }

  updateDbSize();
  setInterval(updateDbSize, 1000); // 10 segundos 

  updateTable();
  setInterval(updateTable, 3000);
  const editCtx = document.getElementById("editTypeChart");
  const editChart = new Chart(editCtx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Tipos de edición",
        data: [],
        backgroundColor: "#22c55e"
      }]
    },
    options: {
      plugins: { legend: { display: false } }
    }
  });

  async function updateEditTypes() {
    const res = await fetch("/api/type_edit");
    const json = await res.json();

    editChart.data.labels = json.data.map(e => e._id || "unknown");
    editChart.data.datasets[0].data = json.data.map(e => e.count);
    editChart.update();
}

updateEditTypes();
setInterval(updateEditTypes, 5000);

  const bhCtx = document.getElementById("botHumanChart");
  const bhChart = new Chart(bhCtx, {
    type: "pie",
    data: {
      labels: ["Humanos", "Bots"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#38bdf8", "#f97316"]
      }]
    }
  });

async function updateBotHuman() {
  const res = await fetch("/api/top_usuarios");
  const json = await res.json();

  let humans = 0;
  let bots = 0;

  json.data.forEach(u => {
    humans += u.human_changes;
    bots += u.bot_changes;
  });

  bhChart.data.datasets[0].data = [humans, bots];
  bhChart.update();

  document.getElementById("human-count").textContent = humans;
  document.getElementById("bot-count").textContent = bots;
}

updateBotHuman();
setInterval(updateBotHuman, 5000);



async function updateTopUsers() {
  const res = await fetch("/api/top_usuarios");
  const json = await res.json();

  const body = document.getElementById("top-users-body");
  body.innerHTML = "";

  json.data.forEach(user => {
    const total = user.human_changes + user.bot_changes;

    body.innerHTML += `
      <tr>
        <td>${user._id || "Anónimo"}</td>
        <td>${total}</td>
        <td>${user.human_changes}</td>
        <td>${user.bot_changes}</td>
      </tr>
    `;
  });
}
updateTopUsers();
setInterval(updateTopUsers, 5000);
updateTopUsers();
setInterval(updateTopUsers, 5000);

</script>

</body>
</html>

